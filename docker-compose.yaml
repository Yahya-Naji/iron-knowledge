version: '3.8'

services:
  # üóÑÔ∏è PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ironmountain_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-quanterra_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-ironmountain-db.sh:/docker-entrypoint-initdb.d/init-ironmountain-db.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-quanterra_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - ironmountain-network

  # üß† Autogen Studio (OPTIONAL - run separately or uncomment if you have Dockerfile.autogen)
  # autogen:
  #   build:
  #     context: .
  #     dockerfile: docker/Dockerfile.autogen
  #   container_name: ironmountain_autogen
  #   ports:
  #     - "8081:8001"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   environment:
  #     OPENAI_API_KEY: ${OPENAI_API_KEY}
  #     AUTOGENSTUDIO_DATABASE_URI: "postgresql://${POSTGRES_USER:-quanterra_user}:${POSTGRES_PASSWORD:-changeme123}@postgres:5432/autogen"
  #     AUTOGENSTUDIO_DEFAULT_USER_ID: ${AUTOGEN_USER_ID:-admin@ironmountain.com}
  #     AUTOGENSTUDIO_UPGRADE_DATABASE: "true"
  #   volumes:
  #     - ./autogen-data:/app/data
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   restart: unless-stopped
  #   networks:
  #     - ironmountain-network

  # üìß MCP Email Server
  mcp-email:
    build:
      context: .
      dockerfile: docker/Dockerfile.ironmountain
    container_name: ironmountain_mcp_email
    working_dir: /workspace
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-${SMTP_USER}}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Iron Mountain Assistant}
      EMAIL_INTERNAL: ${EMAIL_INTERNAL}
      EMAIL_CUSTOMER: ${EMAIL_CUSTOMER}
      CANCEL_BASE_URL: ${CANCEL_BASE_URL:-http://localhost:8002}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-quanterra_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: ironmountain
    volumes:
      - ./mcp-servers/ironmountain_mcp_email.py:/workspace/ironmountain_mcp_email.py
    command: ["tail", "-f", "/dev/null"]
    networks:
      - ironmountain-network

  # üóÑÔ∏è MCP Database Server
  mcp-database:
    build:
      context: .
      dockerfile: docker/Dockerfile.ironmountain
    container_name: ironmountain_mcp_database
    working_dir: /workspace
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-quanterra_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: ironmountain
    volumes:
      - ./mcp-servers/ironmountain_mcp_database.py:/workspace/ironmountain_mcp_database.py
    command: ["tail", "-f", "/dev/null"]
    networks:
      - ironmountain-network

  # üí¨ Chainlit UI
  chainlit:
    build:
      context: .
      dockerfile: docker/Dockerfile.chainlit
    container_name: ironmountain_chainlit
    ports:
      - "8002:8001"
    depends_on:
      postgres:
        condition: service_healthy
      # autogen:
      #   condition: service_started
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      CHAINLIT_DATABASE_URI: "postgresql://${POSTGRES_USER:-quanterra_user}:${POSTGRES_PASSWORD:-changeme123}@postgres:5432/chainlit"
      CHAINLIT_AUTH_SECRET: ${CHAINLIT_AUTH_SECRET}
      JWT_SECRET: ${CHAINLIT_AUTH_SECRET}
      AUTOGEN_API_URL: ${AUTOGEN_API_URL:-https://awedly-unstaid-marc.ngrok-free.dev}
      AUTOGEN_WS_URL: ${AUTOGEN_WS_URL:-wss://awedly-unstaid-marc.ngrok-free.dev}
      AUTOGEN_USER_ID: ${AUTOGEN_USER_ID:-guestuser@gmail.com}
      IRONMOUNTAIN_DB_TEAM_ID: ${IRONMOUNTAIN_DB_TEAM_ID:-1}
      IRONMOUNTAIN_EMAIL_TEAM_ID: ${IRONMOUNTAIN_EMAIL_TEAM_ID:-2}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-quanterra_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_DB: ironmountain
    volumes:
      - ./chainlit-app:/app
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["chainlit", "run", "app_ironmountain.py", "--host", "0.0.0.0", "--port", "8001"]
    restart: unless-stopped
    networks:
      - ironmountain-network

networks:
  ironmountain-network:
    driver: bridge

volumes:
  postgres-data:
